pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- sl2z by kisonecat

generators = {
   {{1,-1},{ 0,1}},
   {{1, 1},{ 0,1}},
   {{1, 0},{-1,1}},
   {{1, 0},{ 1,1}}
}

function matmul( m1, m2 )
   if #m1[1] ~= #m2 then
      return nil
   end 
 
   local result = {}
 
   for i = 1, #m1 do
      result[i] = {}
      for j = 1, #m2[1] do
	 result[i][j] = 0
	 for k = 1, #m2 do
	    result[i][j] = result[i][j] + m1[i][k] * m2[k][j]
	 end
      end
   end
   
   return result
end

function random_sl2z()
   local result = {{1,0},{0,1}}

   for i = 1, 5+flr(rnd(5)) do
      result = matmul( result, generators[ceil(rnd(4))] )
   end

   return result
end

matrix = random_sl2z()
word = ""
matrix = {{1,0},{0,1}}
drawn = {{1,0},{0,1}}
timer = 0

function _update()
   local action = nil
   local symbol = nil
   
   if (btnp(0)) then symbol = "a"; action = generators[1] end
   if (btnp(1)) then symbol = "a!"; action = generators[2] end
   if (btnp(2)) then symbol = "b"; action = generators[3] end
   if (btnp(3)) then symbol = "b!"; action = generators[4] end

   if action != nil then
      matrix = drawn
      drawn = matmul(matrix, action)
      word = word .. symbol
      timer = time()
   end

   --if matrix[1][1] == 1 and matrix[2][1] == 0 and matrix[1][2] == 0 and matrix[2][2] == 1 then
   --matrix = random_sl2z()
   --end
end

function _draw()
   cls()

   local speed = 0.25
   local t = (time() - timer) / speed
   local s = 1 - t

   if (t > 1) then
      matrix = drawn
   end
   
   local m00 = s*matrix[1][1] + t*drawn[1][1]
   local m01 = s*matrix[1][2] + t*drawn[1][2]
   local m10 = s*matrix[2][1] + t*drawn[2][1]
   local m11 = s*matrix[2][2] + t*drawn[2][2]
   
   local vmem = 0x6000

   local dx, nx
   local dy, ny
   local cx, cy

   local scale  = 0.5
   local y = 127 / 32
   local x

   local dxd = m01^2/256 + 1/8*m01*m11
   local nxd = m00*m01/256 + m01*m10/16 + m00*m11/16
   local dyd = m01^2/256 + m01*m11/8
   
   for j = 1, 128 do
      dx =  m01^2*y^2 + 4*m01^2 - 4*m01*m11 + m11^2
      nx =  m00*m01*y^2 + 4*m00*m01 - 2*m01*m10 - 2*m00*m11 + m10*m11
      dy =  m01^2*y^2 + 4*m01^2 - 4*m01*m11 + m11^2
      ny =  -m01*m10*y + m00*m11*y
      y -= 1/32
      
      x = -2
      for i = 1, 64 do
	 dx +=  m01^2*x/8 + dxd
	 nx +=  m00*m01*x/8 + nxd
	 dy +=  m01^2*x/8 + dyd
	 x += 1/16
	 
	 if (ny % dy < 0.5 * dy) == (nx % dx < 0.5 * dx) then
	    poke( vmem, 17 )
	 end
	 vmem = vmem + 1
      end      
   end
    
   print(matrix[1][1],10,10)
   print(matrix[2][1],30,10)
   print(matrix[1][2],10,20)
   print(matrix[2][2],30,20)
   print(word,10,40)
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000001d0000000000000000000000005500000000000000000000000000000000000000000000
0000000005666d100500005555555100000000000000000000000000600000155555555555555510000d10000000000000000000000000000000000000000000
00000001650001651700005d777d5100000000000000000000000006500000d6677766dd67dd6750000060000000000000000000000000000000000000000000
000000075000000d67000000d7d000000000000000000000000000560000006d761000007500d600000056000000000000000000000000000000000000000000
000000d60000000077000000d7d00000000000000000000000000060000000675000000d60017100000006100000000000000000000000000000000000000000
000000650000000057000000d7d000000000000000000000000005600000007d0000001710065000000005600000000000000000000000000000000000000000
000000750000000007000000d7d00000000000000000000000000650000000710000006d00560000000000700000000000000000000000000000000000000000
000000760000000006000000d7d00000000000000000000000001700000000500000057000750000000000650000000000000000000000000000000000000000
000000675000000005000000d7d0000000000000000000000000560000000000000007500d600000000000560000000000000000000000000000000000000000
000000577500000000000000d7d00000000000000000000000006d00000000000000d60017000000000000570000000000000000000000000000000000000000
0000000d7776510000000000d7d00000000000000000000000007500000000000001700065000000000000171000000000000000000000000000000000000000
000000005777776500000000d7d00000000000000000000000007500000000000006500560000000000000075000000000000000000000000000000000000000
000000000015677760000000d7d00000000000000000000000007100000000000056000710000000000000075000000000000000000000000000000000000000
000000000000005776000000d7d00000000000001dd6650000017100000000000071006d00000000000000075000000000000000000000000000000000000000
000000000000000077100000d7d0000000000001d0005750000170000000000006d005700000000000000006d000000000000000000000000000000000000000
000000100000000057500000d7d000000000d00d0000067000017000000000005700075000000055000000065000000000000000000000000000000000000000
000000d00000000007d00000d7d000000000d0076000057500007100000000006500d60000000075000000075000000000000000000000000000000000000000
000000600000000006d00000d7d000000000600dd000057500007100000000056001710000000571000000075000000000000000000000000000000000000000
000000700000000007500000d7d00000000160000000067000007500000000171006d00000000670000000071000000000000000000000000000000000000000
0000007d0000000017100000d7d000000006d00000001750000065000000006d0057000000006670000000171000000000000000000000000000000000000000
00000076500000006d000000d7d0000000d7d00000006d000000dd00000005700075000000576560000000570000000000000000000000000000000000000000
00000070d6500016d000005567655555d7775000000dd000000056000000076dd67ddddd6777d6d0000000d60000000000000000000000000000000000000000
0000005001d666650000005ddddddddddddd1000005d000000000700000005ddddddddddddddd510000000650000000000000000000000000000000000000000
000000000000000000000000000000000000000005d0000100000650000000000000000000000000000000700000000000000000000000000000000000000000
0000000000000000000000000000000000000000150000510000056000000000000000000000000000000dd00000000000000000000000000000000000000000
00000000000000000000000000000000000000016ddddd6000000061000000000000000000000000000006000000000000000000000000000000000000000000
000000000000000000000000000000000000000677777770000000160000000000000000000000000000d5000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000d500000000000000000000000000160000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000610000000000000000000000000600000000000000000000000000000000000000000000
